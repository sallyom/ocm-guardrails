---
# Job to rotate an agent's API key
# Usage:
#   1. Edit AGENT_NAME below (e.g., "philbot", "techbot", etc.)
#   2. oc apply -f rotate-agent-key-job.yaml
#   3. Delete job when done: oc delete job rotate-agent-key
apiVersion: batch/v1
kind: Job
metadata:
  name: rotate-agent-key
  namespace: openclaw
  labels:
    app: openclaw
    job: rotate-key
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: openclaw
        job: rotate-key
    spec:
      restartPolicy: OnFailure
      containers:
      - name: rotate-key
        image: registry.redhat.io/ubi9/ubi-minimal:latest
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 200m
        command:
        - /bin/bash
        - -c
        - |
          set -e

          # ============================================
          # CONFIGURE THIS: Which agent to rotate
          # ============================================
          AGENT_NAME="philbot"
          # Options: philbot, techbot, poetbot, conversationalist
          # ============================================

          echo "Downloading jq..."
          curl -sL https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
          chmod +x /tmp/jq

          MOLTBOOK_API="http://moltbook-api.moltbook.svc.cluster.local:3000"
          ADMIN_KEY="${ADMIN_API_KEY}"

          if [ -z "$ADMIN_KEY" ]; then
            echo "ERROR: ADMIN_API_KEY environment variable not set"
            echo "Make sure AdminBot is registered first"
            exit 1
          fi

          echo "Rotating API key for ${AGENT_NAME}..."

          # Call rotation endpoint
          RESPONSE=$(curl -s -X POST \
            "$MOLTBOOK_API/api/v1/admin/agents/${AGENT_NAME}/rotate-key" \
            -H "Authorization: Bearer $ADMIN_KEY" \
            -H "Content-Type: application/json")

          # Extract new API key
          NEW_KEY=$(echo "$RESPONSE" | /tmp/jq -r '.api_key')

          if [ "$NEW_KEY" = "null" ] || [ -z "$NEW_KEY" ]; then
            echo "ERROR: Failed to rotate API key"
            # Redact credentials before logging
            SAFE_RESPONSE=$(echo "$RESPONSE" | sed 's/"api_key":"[^"]*"/"api_key":"[REDACTED]"/g')
            echo "Response: $SAFE_RESPONSE"
            exit 1
          fi

          echo "✅ Key rotated successfully! New key: ${NEW_KEY:0:20}..."

          # Update Kubernetes secret
          echo "Updating Kubernetes secret..."

          # Determine secret name based on agent name
          SECRET_NAME="${AGENT_NAME}-moltbook-key"

          # Create/update secret
          oc create secret generic "$SECRET_NAME" \
            -n openclaw \
            --from-literal=api_key="$NEW_KEY" \
            --dry-run=client -o yaml | oc apply -f -

          echo "✅ Secret ${SECRET_NAME} updated!"
          echo ""
          echo "Next steps:"
          echo "  1. Update agent .env file:"
          echo "     oc delete job openclaw-agent-setup -n openclaw"
          echo "     oc apply -f agent-setup-job.yaml"
          echo "  2. Restart OpenClaw if agent is already running"
          echo ""
          echo "API key rotation complete!"

        env:
        - name: ADMIN_API_KEY
          valueFrom:
            secretKeyRef:
              name: adminbot-moltbook-key
              key: api_key
      serviceAccountName: openclaw-agent-manager
